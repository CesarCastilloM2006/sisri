<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Blue Basin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.5.2/dist/maplibre-gl.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            color: #333;
        }

        .container {
            padding: 20px;
            margin-left: 0;
            transition: margin-left 0.3s;
        }

        .variables-panel {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        #sisri-demo-map .leaflet-container {
            background: #eaf6ff;
        }
        #sisri-demo-map, #sisri-demo-map3d {
            width: 100%;
            height: 60vh;
            margin-bottom: 2rem;
        }
        #sisri-demo-map3d { display: none; }
    </style>
</head>
<body>

    <!-- Contenido Principal -->
    <div class="container">
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-4">
        <a href="index.html" class="btn btn-outline-secondary">Inicio</a>
        <a href="análisis.html" class="btn btn-outline-secondary">Análisis Satelital</a>
        <a href="#" class="btn btn-outline-secondary">Visualización</a>
        <a href="historial.html" class="btn btn-outline-secondary">Historial</a>
        <a href="predicciones.html" class="btn btn-outline-secondary">Análisis Predictivo</a>
      </div>
      <div class="mb-4 d-flex justify-content-end">
        <button id="toggle3d" class="btn btn-outline-primary">Cambiar a 3D</button>
      </div>
      <div id="sisri-demo-map" style="width:100%;height:60vh;margin-bottom:2rem;"></div>
      <div id="sisri-demo-map3d" style="width:100%;height:60vh;display:none;margin-bottom:2rem;"></div>
      <div class="variables-panel mb-4" id="sisriVariablesPanel">
        <h4>Variables Ambientales de la Zona Seleccionada</h4>
        <div class="table-responsive">
          <table class="table table-striped" id="variablesTable">
            <thead>
              <tr>
                <th>Variable</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="2"><em>Selecciona un área en el mapa para ver los datos ambientales.</em></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
    <script>
      // 2D MAPA (Leaflet con satélite y dibujo de polígonos)
      var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      });
      var demoMap = L.map('sisri-demo-map', {
        center: [19.4326, -99.1332],
        zoom: 14,
        layers: [satelliteLayer]
      });
      var demoDrawnItems = new L.FeatureGroup();
      demoMap.addLayer(demoDrawnItems);
      var demoDrawControl = new L.Control.Draw({
        edit: { featureGroup: demoDrawnItems },
        draw: {
          polygon: true,
          marker: false,
          polyline: false,
          circle: false,
          rectangle: false,
          circlemarker: false
        }
      });
      demoMap.addControl(demoDrawControl);
      // Polygon drawing for 3D map
      var drawnPolygon3D = null;
      function addPolygonTo3DMap(latlngs) {
        if (!map3d) return;
        if (drawnPolygon3D) {
          map3d.removeLayer(drawnPolygon3D);
        }
        drawnPolygon3D = new maplibregl.Marker({color: '#3388ff'}).setLngLat(latlngs[0]).addTo(map3d);
        // For real polygon drawing in MapLibre, a custom layer or GeoJSON source is needed (advanced, can be implemented if required)
      }
      demoMap.on(L.Draw.Event.CREATED, function (event) {
        demoDrawnItems.clearLayers();
        var layer = event.layer;
        demoDrawnItems.addLayer(layer);
        var latlngs = layer.getLatLngs()[0].map(function(latlng) {
          return [latlng.lng, latlng.lat]; // MapLibre uses [lng,lat]
        });
        var variables = getDemoVariablesForPolygon(latlngs);
        var tbody = document.querySelector('#variablesTable tbody');
        tbody.innerHTML = '';
        for (var key in variables) {
          var tr = document.createElement('tr');
          var td1 = document.createElement('td');
          var td2 = document.createElement('td');
          td1.textContent = key;
          td2.textContent = variables[key];
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        }
        // Draw in 3D map if active
        if (map3dLoaded && document.getElementById('sisri-demo-map3d').style.display === 'block') {
          addPolygonTo3DMap(latlngs);
        }
      });

      // 3D MAPA (MapLibre GL JS)
      var map3dLoaded = false;
      var map3d;
      document.getElementById('toggle3d').addEventListener('click', function() {
        var btn = this;
        var map2d = document.getElementById('sisri-demo-map');
        var map3dDiv = document.getElementById('sisri-demo-map3d');
        if (map3dDiv.style.display === 'none') {
          map2d.style.display = 'none';
          map3dDiv.style.display = 'block';
          btn.textContent = 'Cambiar a 2D';
          if (!map3dLoaded) {
            map3d = new maplibregl.Map({
              container: 'sisri-demo-map3d',
              style: 'https://api.maptiler.com/maps/hybrid/style.json?key=cI5UpDE37iWXyDXV4rVN', // KEY INCLUIDA
              center: [-99.1332, 19.4326],
              zoom: 14,
              pitch: 60,
              bearing: -17.6,
              antialias: true
            });
            map3dLoaded = true;
          }
        } else {
          map2d.style.display = 'block';
          map3dDiv.style.display = 'none';
          btn.textContent = 'Cambiar a 3D';
        }
        // Si hay polígono dibujado en 2D y cambias a 3D, dibuja marcador en el centro
        var lastPolygon = demoDrawnItems.getLayers()[0];
        if (lastPolygon) {
          var latlngs = lastPolygon.getLatLngs()[0].map(function(latlng) { return [latlng.lng, latlng.lat]; });
          addPolygonTo3DMap(latlngs);
        }
      });
      function getDemoVariablesForPolygon(latlngs) {
        // Aquí deberías hacer una petición AJAX a tu backend con las coordenadas
        // Por ahora, devolvemos datos simulados
        return {
          'Temperatura promedio': (20 + Math.random()*8).toFixed(1) + ' °C',
          'Humedad relativa': (40 + Math.random()*40).toFixed(0) + ' %',
          'Humedad del suelo': (10 + Math.random()*30).toFixed(0) + ' %',
          'Radiación solar': (500 + Math.random()*300).toFixed(0) + ' W/m²',
          'Velocidad del viento': (2 + Math.random()*4).toFixed(1) + ' m/s',
          'Evapotranspiración': (3 + Math.random()*2).toFixed(2) + ' mm/día'
        };
      }
    </script>

</body>
</html>
